name: API Report Approval

on:
  pull_request:
    branches:
      - main
    paths:
      - '**/*api.json'
      - '**/*api_changes_report.md'

jobs:
  label-api-changes:
    name: Label API Changes
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Check for API changes
        id: check-api-changes
        run: |
          # Check for changes in API JSON files
          API_JSON_CHANGES=$(git diff --name-only origin/main...HEAD | grep 'api\.json' || true)
          
          # Special handling for api_changes_report.md - check content instead of just diff
          REPORT_FILE="packages/amplify_core/api_changes_report.md"
          REPORT_CHANGED=$(git diff --name-only origin/main...HEAD | grep "$REPORT_FILE" || true)
          REAL_API_CHANGES=false
          
          if [[ -n "$REPORT_CHANGED" ]]; then
            # Get the report content from both branches
            git show origin/main:"$REPORT_FILE" > /tmp/main_report.md || echo "# No previous report" > /tmp/main_report.md
            git show HEAD:"$REPORT_FILE" > /tmp/pr_report.md || echo "# No report in PR" > /tmp/pr_report.md
            
            # Check if both reports indicate "No changes detected"
            if grep -q "No changes detected" /tmp/main_report.md && grep -q "No changes detected" /tmp/pr_report.md; then
              echo "Both reports show no API changes - ignoring timestamp differences."
            else
              echo "API changes report shows actual changes. Please review the report."
              REAL_API_CHANGES=true
            fi
          fi
          
          if [[ -n "$API_JSON_CHANGES" || "$REAL_API_CHANGES" == "true" ]]; then
            echo "API_CHANGES_DETECTED=true" >> $GITHUB_ENV
            echo "API changes detected in the following files:"
            if [[ -n "$API_JSON_CHANGES" ]]; then
              echo "$API_JSON_CHANGES"
            fi
            if [[ "$REAL_API_CHANGES" == "true" ]]; then
              echo "$REPORT_FILE"
            fi
          else
            echo "API_CHANGES_DETECTED=false" >> $GITHUB_ENV
            echo "No API changes detected."
          fi

      - name: Add API changes label
        if: env.API_CHANGES_DETECTED == 'true'
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['api-changes']
            })
            
      - name: Comment on PR
        if: env.API_CHANGES_DETECTED == 'true'
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Check if we already commented about API changes
            const commentMarker = '⚠️ This PR contains API changes';
            const { data: comments } = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            
            // Look for an existing comment with our marker
            const apiChangeComment = comments.find(comment => 
              comment.body.includes(commentMarker) && 
              comment.user.login === 'github-actions[bot]'
            );
            
            // Only create a comment if we haven't already
            if (!apiChangeComment) {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: '⚠️ This PR contains API changes and requires careful review. Please ensure these changes are intentional and backward compatible where possible.'
              });
            } else {
              console.log('API changes comment already exists, skipping comment creation');
            }
