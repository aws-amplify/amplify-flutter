name: Flutter Package
on:
  workflow_call:
    inputs:
      working-directory:
        description: The working directory relative to the repo root
        required: true
        type: string

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        sdk:
          - stable
          - master
    steps:
      - name: Git Checkout
        uses: actions/checkout@2541b1294d2704b0964813337f33b291d3f8596b

      - name: Setup Flutter
        uses: subosito/flutter-action@45dd344cec959c99c9e3b1dbf3eac51907ffe1aa
        with:
          cache: true
          channel: ${{ matrix.sdk }}

      - name: Setup aft
        run: flutter pub global activate -spath packages/aft

      - name: Bootstrap
        run: aft bootstrap -v

      - name: Check Formatting
        run: flutter format --set-exit-if-changed .
        working-directory: ${{ inputs.working-directory }}

      - name: Analyze
        run: flutter analyze --fatal-infos --fatal-warnings lib test
        working-directory: ${{ inputs.working-directory }}

      - name: Run Tests (VM)
        run: aft test unit -- -j 4
        working-directory: ${{ inputs.working-directory }}

  # Native Test runs code on non-Linux platforms and for all Dart->JS compilers
  native_test:
    name: Native Test
    needs: test
    if: ${{ github.event_name == 'pull_request' }} # TODO: Change to 'push'
    strategy:
      matrix:
        os:
          # macos-latest currently points to macos-11
          # https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#jobsjob_idruns-on
          - macos-12
          - windows-latest
    runs-on: ${{ matrix.os }}
    steps:
      - name: Git Checkout
        uses: actions/checkout@2541b1294d2704b0964813337f33b291d3f8596b

      - name: Setup Flutter
        uses: subosito/flutter-action@45dd344cec959c99c9e3b1dbf3eac51907ffe1aa
        with:
          cache: true
          channel: stable

      - name: Setup aft
        run: flutter pub global activate -spath packages/aft

      - name: Bootstrap
        run: aft bootstrap -v

      - name: Check Formatting
        run: flutter format --set-exit-if-changed .
        working-directory: ${{ inputs.working-directory }}

      - name: Analyze
        run: flutter analyze --fatal-infos --fatal-warnings lib test
        working-directory: ${{ inputs.working-directory }}

      - name: Run Tests (VM)
        run: aft test unit -- -j 4
        working-directory: ${{ inputs.working-directory }}
