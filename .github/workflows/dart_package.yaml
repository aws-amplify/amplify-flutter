name: Dart Package
on:
  workflow_call:
    inputs:
      needs-build:
        description: Whether the packages needs `build_runner` to run before tests
        required: false
        type: boolean
        default: false
      working-directory:
        description: The working directory relative to the repo root
        required: true
        type: string

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        sdk:
          - 2.17.0
          - stable
          - dev
    steps:
      - name: Cache Pub dependencies
        uses: actions/cache@b195c997a41f41d0dab6d9aafe79e437611b78db
        with:
          path: |
            ~/.pub-cache/hosted
            ~/.pub-cache/git
          key: os:ubuntu-latest;sdk:${{ matrix.sdk }};packages:${{ inputs.working-directory }}
          restore-keys: |
            os:ubuntu-latest;sdk:${{ matrix.sdk }};packages:${{ inputs.working-directory }}
            os:ubuntu-latest;sdk:${{ matrix.sdk }}
            os:ubuntu-latest

      - name: Git Checkout
        uses: actions/checkout@2541b1294d2704b0964813337f33b291d3f8596b

      # - id: setup
      #   name: Setup Dart
      #   uses: subosito/flutter-action@45dd344cec959c99c9e3b1dbf3eac51907ffe1aa
      #   with:
      #     cache: true
      #     channel: ${{ matrix.sdk }}

      - name: Setup Dart
        uses: dart-lang/setup-dart@196f54580e9eee2797c57e85e289339f85e6779d
        with:
          sdk: ${{ matrix.sdk }}

      - name: Link Packages
        run: |
          dart pub global activate -spath packages/aft
          aft link

      - name: Bootstrap
        if: ${{ inputs.needs-build }}
        run: |
          aft bootstrap --upgrade

      - name: Get Packages
        run: dart pub upgrade
        working-directory: ${{ inputs.working-directory }}

      - name: Check Formatting
        run: dart format --set-exit-if-changed .
        working-directory: ${{ inputs.working-directory }}

      - name: Analyze
        run: dart analyze --fatal-infos --fatal-warnings lib test
        working-directory: ${{ inputs.working-directory }}

      - name: Run Tests (VM)
        run: dart test -j 4
        working-directory: ${{ inputs.working-directory }}

      - name: Run Tests (DDC)
        if: ${{ inputs.needs-build }}
        run: dart run build_runner test --delete-conflicting-outputs -- -j 4 -p chrome,firefox
        working-directory: ${{ inputs.working-directory }}

      - name: Run Tests (dart2js)
        if: ${{ inputs.needs-build }}
        run: dart run build_runner test --release --delete-conflicting-outputs -- -j 4 -p chrome,firefox
        working-directory: ${{ inputs.working-directory }}

      - name: Run Tests (dart2js)
        if: ${{ !inputs.needs-build }}
        run: dart test -j 4 -p chrome,firefox
        working-directory: ${{ inputs.working-directory }}

  native_test:
    name: Native Test
    needs: test
    if: ${{ github.event_name == 'pull_request' }}
    strategy:
      matrix:
        os:
          # macos-latest currently points to macos-11
          # https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#jobsjob_idruns-on
          - macos-12
          - windows-latest
    runs-on: ${{ matrix.os }}
    steps:
      - name: Cache Pub dependencies
        uses: actions/cache@b195c997a41f41d0dab6d9aafe79e437611b78db
        with:
          path: |
            ~/.pub-cache/hosted
            ~/.pub-cache/git
          key: os:${{ matrix.os }};sdk:stable;packages:${{ inputs.working-directory }}
          restore-keys: |
            os:${{ matrix.os }};sdk:stable;packages:${{ inputs.working-directory }}
            os:${{ matrix.os }};sdk:stable
            os:${{ matrix.os }}

      - name: Git Checkout
        uses: actions/checkout@2541b1294d2704b0964813337f33b291d3f8596b

      # - name: Setup Dart
      #   uses: subosito/flutter-action@45dd344cec959c99c9e3b1dbf3eac51907ffe1aa
      #   with:
      #     channel: stable

      - name: Setup Dart
        uses: dart-lang/setup-dart@196f54580e9eee2797c57e85e289339f85e6779d
        with:
          sdk: stable

      - name: Link Packages
        run: |
          dart pub global activate -spath packages/aft
          aft link

      - name: Bootstrap
        if: ${{ inputs.needs-build }}
        run: |
          aft bootstrap --upgrade

      - name: Get Packages
        run: dart pub upgrade
        working-directory: ${{ inputs.working-directory }}

      - name: Check Formatting
        run: dart format --set-exit-if-changed .
        working-directory: ${{ inputs.working-directory }}

      - name: Analyze
        run: dart analyze --fatal-infos --fatal-warnings lib test
        working-directory: ${{ inputs.working-directory }}

      - name: Test (VM)
        run: dart test -j 4
        working-directory: ${{ inputs.working-directory }}
